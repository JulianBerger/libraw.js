name: C/C++ CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  build:
    runs-on: ubuntu-latest
    name: build
    steps:
      - uses: actions/checkout@v2
        id: checkout-code
        name: Checkout
      - id: cache-libraw
        name: Cache LibRaw
        uses: actions/cache@v2
        with:
          path: /home/runner/work/libraw.js/libraw.js/LibRaw-0.19.5.tar.gz
          key: ${{ runner.os }}-LibRaw-0.19.5.tar.gz
          restore-keys: ${{ runner.os }}-LibRaw-0.19.5.tar.gz
      - id: list-files
        name: Run ls
        run: ls
      - id: list-root
        name: Run ls root
        run: ls /
      - id: refresh-cache
        name: Download LibRaw if not cached
        if: steps.cache-libraw.outputs.cache-hit != 'true'
        run: curl https://www.libraw.org/data/LibRaw-0.19.5.tar.gz --output LibRaw-0.19.5.tar.gz
      - id: install-libraw
        name: Install LibRaw
        run: tar xzvf LibRaw-0.19.5.tar.gz && cd LibRaw-0.19.5 && ./configure && touch * && make && sudo make install
      - id: set-ld-library
        name: LD Library
        run: sudo ldconfig -v && LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/lib
      - id: clean-libraw-files
        name: Clean LibRaw Build Files
        run: rm -rf LibRaw-0.19.5 LibRaw-0.19.5.tar.gz
      - id: global-npm
        name: Setup Global npm Packages
        run: sudo npm i -g node-gyp
      - id: install-npm
        name: Install npm Packages
        run: npm install
      - id: lint
        name: Lint
        run: npm run format-check && npm run lint
      - id: build-package
        name: Build Package
        run: node-gyp configure && node-gyp build
      - id: unit-tests
        name: Run Unit Tests
        run: npm run test
